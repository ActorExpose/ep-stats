
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Evaluation package for experimentation platform.">
      
      
      
        <meta name="author" content="Team Doodlebug">
      
      
        <link rel="canonical" href="https://github.com/avast/ep-stats/stats/compound_metrics.html">
      
      <link rel="shortcut icon" href="../experiment_b.png">
      <meta name="generator" content="mkdocs-1.1.2, mkdocs-material-6.2.3">
    
    
      
        <title>Compound Metrics - Ep-Stats</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.3b61ea93.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.39b8e14a.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style>
      
    
    
    
    
      
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
      
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#compound-metrics" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid" aria-label="Header">
    <a href="https://github.com/avast/ep-stats" title="Ep-Stats" class="md-header-nav__button md-logo" aria-label="Ep-Stats">
      
  <img src="../experiment_w.png" alt="logo">

    </a>
    <label class="md-header-nav__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header-nav__title" data-md-component="header-title">
      <div class="md-header-nav__ellipsis">
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            Ep-Stats
          </span>
        </div>
        <div class="md-header-nav__topic">
          <span class="md-ellipsis">
            
              Compound Metrics
            
          </span>
        </div>
      </div>
    </div>
    
      <label class="md-header-nav__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" data-md-state="active" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <button type="reset" class="md-search__icon md-icon" aria-label="Clear" data-md-component="search-reset" tabindex="-1">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header-nav__source">
        
<a href="https://github.com/avast/ep-stats/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    avast/ep-stats
  </div>
</a>
      </div>
    
  </nav>
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    




<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="https://github.com/avast/ep-stats" title="Ep-Stats" class="md-nav__button md-logo" aria-label="Ep-Stats">
      
  <img src="../experiment_w.png" alt="logo">

    </a>
    Ep-Stats
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/avast/ep-stats/" title="Go to repository" class="md-source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    avast/ep-stats
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-1" type="checkbox" id="nav-1" >
    
    <label class="md-nav__link" for="nav-1">
      Home
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Home" data-md-level="1">
      <label class="md-nav__title" for="nav-1">
        <span class="md-nav__icon md-icon"></span>
        Home
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../index.html" class="md-nav__link">
      Introduction
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../principles.html" class="md-nav__link">
      Principles
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../resources.html" class="md-nav__link">
      Resources
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" >
    
    <label class="md-nav__link" for="nav-2">
      User Guide
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="User Guide" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        <span class="md-nav__icon md-icon"></span>
        User Guide
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/quick_start.html" class="md-nav__link">
      Quick Start
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/protocol.html" class="md-nav__link">
      Experimentation Protocol
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/ep_in_python.html" class="md-nav__link">
      Using Ep-Stats in Jupyter
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/aggregation.html" class="md-nav__link">
      Aggregation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/configuring_api.html" class="md-nav__link">
      Configuring API
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../user_guide/test_data.html" class="md-nav__link">
      Test Data
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  


  
  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Statistics
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="Statistics" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        <span class="md-nav__icon md-icon"></span>
        Statistics
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="basics.html" class="md-nav__link">
      Basics
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="sample_size.html" class="md-nav__link">
      Sample Size
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="sequential.html" class="md-nav__link">
      Sequential Evaluation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="ctr.html" class="md-nav__link">
      CTR Metric Redefined
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="multiple.html" class="md-nav__link">
      Multiple Comparison Correction
    </a>
  </li>

        
          
          
          


  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Compound Metrics
        <span class="md-nav__icon md-icon"></span>
      </label>
    
    <a href="compound_metrics.html" class="md-nav__link md-nav__link--active">
      Compound Metrics
    </a>
    
      
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-vs-compound-metrics" class="md-nav__link">
    Simple vs Compound Metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solutions" class="md-nav__link">
    Solutions
  </a>
  
    <nav class="md-nav" aria-label="Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#let-it-be-as-it-is" class="md-nav__link">
    Let it be as it is
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-value-squared-correctly" class="md-nav__link">
    Compute Value Squared correctly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-the-error" class="md-nav__link">
    Correct the error
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-adjustment-subtraction" class="md-nav__link">
    Error adjustment - subtraction
  </a>
  
    <nav class="md-nav" aria-label="Error adjustment - subtraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-one-user" class="md-nav__link">
    Only one user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-users" class="md-nav__link">
    Multiple users
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-adjustment-summation" class="md-nav__link">
    Error adjustment - summation
  </a>
  
    <nav class="md-nav" aria-label="Error adjustment - summation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-one-user_1" class="md-nav__link">
    Only one user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-users_1" class="md-nav__link">
    Multiple users
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
    
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      



  
  <li class="md-nav__item md-nav__item--nested">
    
    
      <input class="md-nav__toggle md-toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4" >
    
    <label class="md-nav__link" for="nav-4">
      API
      <span class="md-nav__icon md-icon"></span>
    </label>
    <nav class="md-nav" aria-label="API" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        <span class="md-nav__icon md-icon"></span>
        API
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          



  <li class="md-nav__item">
    <a href="../api/experiment.html" class="md-nav__link">
      Experiment
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/evaluation.html" class="md-nav__link">
      Evaluation
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/statistics.html" class="md-nav__link">
      Statistics
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/check.html" class="md-nav__link">
      Check
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/srm_check.html" class="md-nav__link">
      SrmCheck
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/dao.html" class="md-nav__link">
      Dao
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/dao_factory.html" class="md-nav__link">
      DaoFactory
    </a>
  </li>

        
          
          
          



  <li class="md-nav__item">
    <a href="../api/test_data.html" class="md-nav__link">
      TestData
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#example" class="md-nav__link">
    Example
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#simple-vs-compound-metrics" class="md-nav__link">
    Simple vs Compound Metrics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#solutions" class="md-nav__link">
    Solutions
  </a>
  
    <nav class="md-nav" aria-label="Solutions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#let-it-be-as-it-is" class="md-nav__link">
    Let it be as it is
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute-value-squared-correctly" class="md-nav__link">
    Compute Value Squared correctly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#correct-the-error" class="md-nav__link">
    Correct the error
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-adjustment-subtraction" class="md-nav__link">
    Error adjustment - subtraction
  </a>
  
    <nav class="md-nav" aria-label="Error adjustment - subtraction">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-one-user" class="md-nav__link">
    Only one user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-users" class="md-nav__link">
    Multiple users
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#error-adjustment-summation" class="md-nav__link">
    Error adjustment - summation
  </a>
  
    <nav class="md-nav" aria-label="Error adjustment - summation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#only-one-user_1" class="md-nav__link">
    Only one user
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#multiple-users_1" class="md-nav__link">
    Multiple users
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/avast/ep-stats/edit/master/docs/stats/compound_metrics.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="compound-metrics">Compound Metrics<a class="headerlink" href="#compound-metrics" title="Permanent link">&para;</a></h1>
<p>There are metrics in Experimentation Platform, which are compounded, i.e. the nominator does not consist of value or count from a single goal, but it is composed from multiple goals. However, when we combine multiple goals into one, there might occur issues with standard deviation (variance).</p>
<p>In data pipeline we save goals in multiple stages of aggregation:</p>
<ol>
<li>
<p><strong>Tracking table</strong> <code>tracking</code>:
Basically raw data, no aggregation applied. Usually one line, one goal.</p>
</li>
<li>
<p><strong>Aggregated Unit Goals table</strong> <code>agg_unit_goals</code>:
Goals are aggregated (grouped by) with respect to <code>experiment_id</code>, <code>variant_id</code>, <code>goal</code> and <code>guid</code>.</p>
</li>
<li>
<p><strong>Aggregated Goals table</strong> <code>agg_goals</code>:
Goals are aggregated (grouped by) with respect to <code>experiment_id</code>, <code>variant_id</code> and <code>goal</code>.</p>
</li>
</ol>
<p>In statistical evaluation in EP we use tables <code>agg_unit_goals</code> and <code>agg_goals</code>, which contain pre-aggregated goals. We do not use table <code>tracking</code> with raw goals. This is mainly due to optimality of SQL queries.</p>
<h2 id="example">Example<a class="headerlink" href="#example" title="Permanent link">&para;</a></h2>
<p>We illustrate differences between tables on the following example. Assume we have two users, Sam and Mike. Sam bought three products for $10, $20 and $50. Than he refunded two of them - the one for $10 and the one for $20. Mike bought two products for $20 and $30. Later he refunded the cheaper one. They are both in A variant of our imaginary experiment.</p>
<p><strong>Tracking table</strong> <code>tracking</code></p>
<table>
<thead>
<tr>
<th>Variant</th>
<th>User</th>
<th>Goal</th>
<th>Count</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>1</td>
<td>$10</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>1</td>
<td>$20</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>1</td>
<td>$50</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>1</td>
<td>$10</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>1</td>
<td>$20</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>1</td>
<td>$20</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>1</td>
<td>$30</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>1</td>
<td>$20</td>
</tr>
</tbody>
</table>
<p><strong>Aggregated Unit Goals table</strong> <code>agg_unit_goals</code></p>
<table>
<thead>
<tr>
<th>Variant</th>
<th>User</th>
<th>Goal</th>
<th>Count</th>
<th>Value</th>
<th>Value Squared</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>3</td>
<td>$80</td>
<td>6,400 (80 * 80)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>2</td>
<td>$30</td>
<td>900 (30 * 30)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>2</td>
<td>$50</td>
<td>2,500 (50 * 50)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>1</td>
<td>$20</td>
<td>400 (20 * 20)</td>
</tr>
</tbody>
</table>
<p><strong>Aggregated Goals table</strong> <code>agg_goals</code></p>
<table>
<thead>
<tr>
<th>Variant</th>
<th>Goal</th>
<th>Count</th>
<th>Value</th>
<th>Value Squared</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 7L9 19l-5.5-5.5 1.41-1.41L9 16.17 19.59 5.59 21 7z"/></svg></span> purchase</td>
<td>5</td>
<td>$130</td>
<td>8,900 (6,400 + 2,500)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg></span> refund</td>
<td>3</td>
<td>$50</td>
<td>1,300 (900 + 400)</td>
</tr>
</tbody>
</table>
<h2 id="simple-vs-compound-metrics">Simple vs Compound Metrics<a class="headerlink" href="#simple-vs-compound-metrics" title="Permanent link">&para;</a></h2>
<p>From table <code>agg_goals</code> it is easy to compute simple "per User" metrics such as <strong>Bookings per User</strong> or <strong>Refunds per User</strong>.
For example total bookings equals to $130 ($80 Sam + $50 Mike) with sample variance 8,900 (6,400 Sam + 2,500 Mike). Analogously total refunds equals to $50 ($30 Sam + $20 Mike) with sample variance 1,300 (900 Sam + 400 Mike).</p>
<p>The issues might arise when we think about compound metrics. Let assume we are interested in metric <strong>Net Bookings per User</strong>. In this metric we do not want to count purchases which were later refunded.
Ideal situation would be if we had goal <code>net purchases</code>. This goal would be defined as <code>purchases</code> - <code>refunds</code>. If we compute <code>net purchases</code> from already aggregated goals, we overestimate the sample variance (<code>Value Squared</code>).</p>
<p><strong>Aggregated Unit Goals table</strong> <code>agg_unit_goals</code>
(Overestimating sample variance - the way how we compute it now)</p>
<table>
<thead>
<tr>
<th>Variant</th>
<th>User</th>
<th>Goal</th>
<th>Count</th>
<th>Value</th>
<th>Value Squared</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.41 13.41L6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7z"/></svg></span> net purchases</td>
<td>1</td>
<td>$50</td>
<td>5,500 (6,400 - 900)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.41 13.41L6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7z"/></svg></span> net purchases</td>
<td>1</td>
<td>$30</td>
<td>2,100 (2,500 - 400)</td>
</tr>
</tbody>
</table>
<p>This is exactly what we get if we use <code>agg_unit_goals</code> table. Now look closer. Sam bought three items for $10, $20 and $50. He refunded two of them for $10 and $20. In summary, Sam made one valid purchase for $50. Mike bought two items for $20 and $30. He refunded the first one. So do Mike made only one valid purchase for $30. Therefore, the <code>agg_unit_goals</code> table for (non-existing) goal <code>net purchases</code> should looks like this.</p>
<p><strong>Aggregated Unit Goals table</strong> <code>agg_unit_goals</code>
(True sample variance - the way how we should compute it)</p>
<table>
<thead>
<tr>
<th>Variant</th>
<th>User</th>
<th>Goal</th>
<th>Count</th>
<th>Value</th>
<th>Value Squared</th>
</tr>
</thead>
<tbody>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Sam</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.41 13.41L6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7z"/></svg></span> net purchases</td>
<td>1</td>
<td>$50</td>
<td>2,500 (50 * 50)</td>
</tr>
<tr>
<td>A</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 19.2c-2.5 0-4.71-1.28-6-3.2.03-2 4-3.1 6-3.1s5.97 1.1 6 3.1a7.232 7.232 0 01-6 3.2M12 5a3 3 0 013 3 3 3 0 01-3 3 3 3 0 01-3-3 3 3 0 013-3m0-3A10 10 0 002 12a10 10 0 0010 10 10 10 0 0010-10c0-5.53-4.5-10-10-10z"/></svg></span> Mike</td>
<td><span class="twemoji"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M.41 13.41L6 19l1.41-1.42L1.83 12m20.41-6.42L11.66 16.17 7.5 12l-1.43 1.41L11.66 19l12-12M18 7l-1.41-1.42-6.35 6.35 1.42 1.41L18 7z"/></svg></span> net purchases</td>
<td>1</td>
<td>$30</td>
<td>900 (30 * 30)</td>
</tr>
</tbody>
</table>
<p>Now when we compute metric <strong>Net Bookings per User</strong> from the first table, we end up with two purchases with total value of $80 and <strong>total sample variance 7,600</strong>.</p>
<p>When we compute the same metric from the second table, we end up with two purchases with total value of $80 and <strong>total sample variance 3,400</strong>.</p>
<p>In this specific case <strong>we overestimated sample variance by 4,200 - by 124%</strong>!</p>
<h2 id="solutions">Solutions<a class="headerlink" href="#solutions" title="Permanent link">&para;</a></h2>
<p>There exists three possible solutions of this issue.</p>
<h3 id="let-it-be-as-it-is">Let it be as it is<a class="headerlink" href="#let-it-be-as-it-is" title="Permanent link">&para;</a></h3>
<p>We can just let it be as it is now. Actually, there are two scenarios what can happen. We can either overestimate true sample variance or underestimate it.</p>
<p>Overestimating sample variance is not as harmful as underestimating. Overestimating causes we end up with higher p-value and wider confidence intervals. In a nutshell, we are more conservative.
Underestimating is much worse. In this case we have no guarantee our results are trustworthy anymore.</p>
<p>We overestimate the true sample variance if compound metric is subtraction of goals. We underestimate the true sample variance if compound metric is summation of goals. We can both underestimate or overestimate the true sample variance if compound metric is both subtraction and summation of goals.</p>
<h3 id="compute-value-squared-correctly">Compute Value Squared correctly<a class="headerlink" href="#compute-value-squared-correctly" title="Permanent link">&para;</a></h3>
<p>We can compute <code>Value Squared</code> correctly and avoid all these problems. Unfortunately, this straightforward solution is pretty tricky. It demands non-trivial implementation in EP SQL queries. The interim table <code>agg_unit_goals</code> must join itself as many times as many goals compound metric contains.</p>
<p>On the other hand, this is a general solution, and it would solve all problems connected with compound metrics and their sample variances.</p>
<h3 id="correct-the-error">Correct the error<a class="headerlink" href="#correct-the-error" title="Permanent link">&para;</a></h3>
<p>In the next sections we will explicitly derive the error in sample variance. We can adjust the overestimated (underestimated) sample variance using this error. Then we end up with correct value of sample variance. However, this might be messy for compound metrics with more than two goals.</p>
<h2 id="error-adjustment-subtraction">Error adjustment - subtraction<a class="headerlink" href="#error-adjustment-subtraction" title="Permanent link">&para;</a></h2>
<p>When the compound metric consists of subtraction of two goals, we overestimate the true sample variance. Firstly, we derive the error for one user. Secondly, we derive the error form multiple users.</p>
<h3 id="only-one-user">Only one user<a class="headerlink" href="#only-one-user" title="Permanent link">&para;</a></h3>
<p>Let assume we have only one user. The user made <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> purchases and <span><span class="MathJax_Preview">R</span><script type="math/tex">R</script></span> refunds, where <span><span class="MathJax_Preview">R \leq P</span><script type="math/tex">R \leq P</script></span>. We denote values of purchases by <span><span class="MathJax_Preview">p_{i}, \, i = 1, \dots, P</span><script type="math/tex">p_{i}, \, i = 1, \dots, P</script></span> and values of refunds by <span><span class="MathJax_Preview">r_{j}, \, j = 1, \dots, R</span><script type="math/tex">r_{j}, \, j = 1, \dots, R</script></span>.</p>
<p>We want to prove that if we compute sample variance of <code>net purchases</code> from <code>agg_unit_goals</code> table, we will overestimate the true sample variance (right side of inequality). The true sample variance is on the left side of the inequality.</p>
<div>
<div class="MathJax_Preview">\begin{split}
\big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big)^{2} &amp; \leq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
\big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{j = 1}^{R} r_{j} \big)^{2} - 2 \sum_{i = 1}^{P} p_{i} \sum_{j = 1}^{R} r_{j} &amp; \leq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
\big( \sum_{j = 1}^{R} r_{j} \big)^{2} - 2 \sum_{i = 1}^{P} p_{i} \sum_{j = 1}^{R} r_{j} &amp; \leq - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
0 &amp; \leq 2 \sum_{j = 1}^{R} r_{j} \big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big).
\end{split}</div>
<script type="math/tex; mode=display">\begin{split}
\big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big)^{2} & \leq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
\big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{j = 1}^{R} r_{j} \big)^{2} - 2 \sum_{i = 1}^{P} p_{i} \sum_{j = 1}^{R} r_{j} & \leq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
\big( \sum_{j = 1}^{R} r_{j} \big)^{2} - 2 \sum_{i = 1}^{P} p_{i} \sum_{j = 1}^{R} r_{j} & \leq - \big( \sum_{j = 1}^{R} r_{j} \big)^{2}, \\
0 & \leq 2 \sum_{j = 1}^{R} r_{j} \big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big).
\end{split}</script>
</div>
<p>Since <span><span class="MathJax_Preview">p_{i} \geq 0</span><script type="math/tex">p_{i} \geq 0</script></span> for <span><span class="MathJax_Preview">i = 1, \dots, P</span><script type="math/tex">i = 1, \dots, P</script></span> and <span><span class="MathJax_Preview">r_{j} \geq 0</span><script type="math/tex">r_{j} \geq 0</script></span> for <span><span class="MathJax_Preview">j = 1, \dots, R</span><script type="math/tex">j = 1, \dots, R</script></span>, the right side on the last line is greater or equal to zero. We have proved that the original inequality holds - we overestimate the true sample variance. Next, we have explicitly derived the error term</p>
<div>
<div class="MathJax_Preview"> 2 \sum_{j = 1}^{R} r_{j} \big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big). </div>
<script type="math/tex; mode=display"> 2 \sum_{j = 1}^{R} r_{j} \big( \sum_{i = 1}^{P} p_{i} - \sum_{j = 1}^{R} r_{j} \big). </script>
</div>
<h3 id="multiple-users">Multiple users<a class="headerlink" href="#multiple-users" title="Permanent link">&para;</a></h3>
<p>In case of multiple users the problem complicates only slightly. Let assume we have <span><span class="MathJax_Preview">N</span><script type="math/tex">N</script></span> users. So the inequality is following</p>
<div>
<div class="MathJax_Preview"> \sum_{n = 1}^{N} \Big( \sum_{i = 1}^{P_{n}} p_{i,n} - \sum_{j = 1}^{R_{n}} r_{j,n} \Big)^{2} \leq \sum_{n = 1}^{N} \Big( \big( \sum_{i = 1}^{P_{n}} p_{i,n} \big)^{2} - \big( \sum_{j = 1}^{R_{n}} r_{j,n} \big)^{2} \Big). </div>
<script type="math/tex; mode=display"> \sum_{n = 1}^{N} \Big( \sum_{i = 1}^{P_{n}} p_{i,n} - \sum_{j = 1}^{R_{n}} r_{j,n} \Big)^{2} \leq \sum_{n = 1}^{N} \Big( \big( \sum_{i = 1}^{P_{n}} p_{i,n} \big)^{2} - \big( \sum_{j = 1}^{R_{n}} r_{j,n} \big)^{2} \Big). </script>
</div>
<p>Since the inequality holds for every single user, it must also holds if we sum them up.</p>
<p>Also the error by how much do we differ is the sum of single errors</p>
<div>
<div class="MathJax_Preview"> \sum_{n = 1}^{N} \Big( 2 \sum_{j = 1}^{R_{n}} r_{j,n} \big( \sum_{i = 1}^{P_{n}} p_{i,n} - \sum_{j = 1}^{R_{n}} r_{j,n} \big) \Big). </div>
<script type="math/tex; mode=display"> \sum_{n = 1}^{N} \Big( 2 \sum_{j = 1}^{R_{n}} r_{j,n} \big( \sum_{i = 1}^{P_{n}} p_{i,n} - \sum_{j = 1}^{R_{n}} r_{j,n} \big) \Big). </script>
</div>
<h2 id="error-adjustment-summation">Error adjustment - summation<a class="headerlink" href="#error-adjustment-summation" title="Permanent link">&para;</a></h2>
<p>This time we derive error term when we sum two goals. Let assume we want to compute compound metric <strong>All bookings per User</strong> which is defined as purchases plus trial conversions. The compound goal <code>all purchases</code> equals to <code>purchases</code> + <code>trails</code>. In this case we show by how much we underestimate the true sample variance.</p>
<h3 id="only-one-user_1">Only one user<a class="headerlink" href="#only-one-user_1" title="Permanent link">&para;</a></h3>
<p>Again let assume we have only one user. The user made <span><span class="MathJax_Preview">P</span><script type="math/tex">P</script></span> purchases and <span><span class="MathJax_Preview">T</span><script type="math/tex">T</script></span> trial conversions. We denote values of purchases by <span><span class="MathJax_Preview">p_{i}, \, i = 1, \dots, P</span><script type="math/tex">p_{i}, \, i = 1, \dots, P</script></span> and values of trial conversions by <span><span class="MathJax_Preview">t_{k}, \, k = 1, \dots, T</span><script type="math/tex">t_{k}, \, k = 1, \dots, T</script></span>.</p>
<p>We want to prove that if we compute sample variance of <code>all purchases</code> from <code>agg_unit_goals</code> table, we will underestimate the true sample variance (right side of inequality). The true sample variance is on the left side of the inequality.</p>
<div>
<div class="MathJax_Preview">\begin{split}
\big( \sum_{i = 1}^{P} p_{i} + \sum_{k = 1}^{T} t_{k} \big)^{2} &amp; \geq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2}, \\
\big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2} + 2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k} &amp; \geq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2}, \\
2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k} &amp; \geq 0.
\end{split}</div>
<script type="math/tex; mode=display">\begin{split}
\big( \sum_{i = 1}^{P} p_{i} + \sum_{k = 1}^{T} t_{k} \big)^{2} & \geq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2}, \\
\big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2} + 2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k} & \geq \big( \sum_{i = 1}^{P} p_{i} \big)^{2} + \big( \sum_{k = 1}^{T} t_{k} \big)^{2}, \\
2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k} & \geq 0.
\end{split}</script>
</div>
<p>Since <span><span class="MathJax_Preview">p_{i} \geq 0</span><script type="math/tex">p_{i} \geq 0</script></span> for <span><span class="MathJax_Preview">i = 1, \dots, P</span><script type="math/tex">i = 1, \dots, P</script></span> and <span><span class="MathJax_Preview">t_{k} \geq 0</span><script type="math/tex">t_{k} \geq 0</script></span> for <span><span class="MathJax_Preview">k = 1, \dots, T</span><script type="math/tex">k = 1, \dots, T</script></span>, the left side on the last line is greater or equal to zero. We have proved that the original inequality holds - we underestimate the true sample variance. Next, we have explicitly derived the error term</p>
<div>
<div class="MathJax_Preview"> 2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k}. </div>
<script type="math/tex; mode=display"> 2 \sum_{i = 1}^{P} p_{i} \sum_{k = 1}^{T} t_{k}. </script>
</div>
<h3 id="multiple-users_1">Multiple users<a class="headerlink" href="#multiple-users_1" title="Permanent link">&para;</a></h3>
<p>In case of multiple users the problem complicates only slightly. Let assume we have <span><span class="MathJax_Preview">N</span><script type="math/tex">N</script></span> users. So the inequality is following</p>
<div>
<div class="MathJax_Preview"> \sum_{n = 1}^{N} \Big( \sum_{i = 1}^{P_{n}} p_{i,n} + \sum_{k = 1}^{T_{n}} t_{k,n} \Big)^{2} \geq \sum_{n = 1}^{N} \Big( \big( \sum_{i = 1}^{P_{n}} p_{i,n} \big)^{2} + \big( \sum_{k = 1}^{T_{n}} t_{k, n} \big)^{2} \Big). </div>
<script type="math/tex; mode=display"> \sum_{n = 1}^{N} \Big( \sum_{i = 1}^{P_{n}} p_{i,n} + \sum_{k = 1}^{T_{n}} t_{k,n} \Big)^{2} \geq \sum_{n = 1}^{N} \Big( \big( \sum_{i = 1}^{P_{n}} p_{i,n} \big)^{2} + \big( \sum_{k = 1}^{T_{n}} t_{k, n} \big)^{2} \Big). </script>
</div>
<p>Since the inequality holds for every single user, it must also holds if we sum them up.</p>
<p>Also the error by how much do we differ is the sum of single errors</p>
<div>
<div class="MathJax_Preview"> \sum_{n = 1}^{N} \Big( 2 \sum_{i = 1}^{P_{n}} p_{i,n} \sum_{k = 1}^{T_{n}} t_{k,n} \Big). </div>
<script type="math/tex; mode=display"> \sum_{n = 1}^{N} \Big( 2 \sum_{i = 1}^{P_{n}} p_{i,n} \sum_{k = 1}^{T_{n}} t_{k,n} \Big). </script>
</div>
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid" aria-label="Footer">
        
          <a href="multiple.html" class="md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
            </div>
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Multiple Comparison Correction
              </div>
            </div>
          </a>
        
        
          <a href="../api/experiment.html" class="md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-footer-nav__title">
              <div class="md-ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Experiment
              </div>
            </div>
            <div class="md-footer-nav__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2020 Maintained by <a href="https://github.com/avast">Avast</a>.
          </div>
        
        Made with
        <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
          Material for MkDocs
        </a>
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/vendor.08c56446.min.js"></script>
      <script src="../assets/javascripts/bundle.6ced434e.min.js"></script><script id="__lang" type="application/json">{"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script>
      
      <script>
        app = initialize({
          base: "..",
          features: ['tabs'],
          search: Object.assign({
            worker: "../assets/javascripts/worker/search.8c7e0a7e.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML"></script>
      
    
  </body>
</html>